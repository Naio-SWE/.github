name: Publish MkDocs to Pages (Reusable)

on:
  workflow_call:
    inputs:
      source_repository:
        description: 'Source repository (org/repo)'
        required: true
        type: string
      pages_repository:
        description: 'Target Pages repository (org/repo)'
        required: true
        type: string
      pages_ref:
        description: 'Branch in Pages repo'
        required: false
        type: string
        default: 'master'
      publish_path:
        description: 'Path within Pages repo (e.g., mk/swe-docs)'
        required: true
        type: string
      requirements_file:
        description: 'Path to requirements file'
        required: false
        type: string
        default: 'requirements-docs.txt'
      python_version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.x'
      mkdocs_site_dir:
        description: 'MkDocs site output directory'
        required: false
        type: string
        default: 'site'
      runner_labels:
        description: 'Runner labels as JSON array string'
        required: false
        type: string
        default: '["self-hosted", "cpu-only", "Linux", "X64"]'
    secrets:
      pages_deploy_token:
        description: 'PAT with read/write access to Pages repo'
        required: true

jobs:
  build-and-deploy:
    runs-on: ${{ fromJSON(inputs.runner_labels) }}
    permissions:
      contents: read
    steps:
      - name: Checkout source repo
        uses: actions/checkout@v5

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: Install MkDocs + plugins
        run: |
          python -m pip install --upgrade pip
          pip install -r ${{ inputs.requirements_file }}
    
      - name: Build site
        run: mkdocs build --strict --site-dir ${{ inputs.mkdocs_site_dir }}

      - name: Upload built site (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: site
          path: ${{ inputs.mkdocs_site_dir }}
          if-no-files-found: error
          retention-days: 7

      - name: DEBUG - Check if token is empty
        run: |
          TOKEN="${{ secrets.pages_deploy_token }}"
          echo "================================================"
          echo "TOKEN VALIDATION CHECK"
          echo "================================================"
          if [ -z "$TOKEN" ]; then
            echo "❌ FATAL ERROR: Token is EMPTY or NULL"
            echo ""
            echo "The secret 'pages_deploy_token' exists but has no value."
            echo "This means the org-level or repo-level secret DOCS_DEPLOY is empty."
            echo ""
            echo "ACTION REQUIRED:"
            echo "1. Check org secrets: Settings → Secrets → DOCS_DEPLOY"
            echo "2. Verify it has a token value"
            echo "3. Or add DOCS_DEPLOY as a repo-level secret with the token"
            exit 1
          else
            echo "✅ Token exists and has a value"
            echo "Token length: ${#TOKEN} characters"
            echo "Token prefix: ${TOKEN:0:15}..."
            echo ""
          fi

      - name: DEBUG - Test token access to Pages repo
        run: |
          echo "================================================"
          echo "TESTING TOKEN ACCESS TO PAGES REPOSITORY"
          echo "================================================"
          echo "Target repository: ${{ inputs.pages_repository }}"
          echo "Target ref: ${{ inputs.pages_ref }}"
          echo ""
          echo "Attempting to list remote refs..."
          
          if git ls-remote https://x-access-token:${{ secrets.pages_deploy_token }}@github.com/${{ inputs.pages_repository }}.git refs/heads/${{ inputs.pages_ref }} > /dev/null 2>&1; then
            echo "✅ SUCCESS: Token can access ${{ inputs.pages_repository }}"
            echo "✅ Branch '${{ inputs.pages_ref }}' exists and is accessible"
            echo ""
          else
            echo "❌ FAILED: Token cannot access the repository"
            echo ""
            echo "POSSIBLE CAUSES:"
            echo "1. Token is invalid or expired"
            echo "2. Token doesn't have 'repo' or 'Contents: Read and write' permissions"
            echo "3. Token doesn't have access to ${{ inputs.pages_repository }}"
            echo "   - For fine-grained tokens (github_pat_*): Check repository access list"
            echo "   - For classic tokens (ghp_*): Check the token has 'repo' scope"
            echo "4. The person who created the token doesn't have push access to the Pages repo"
            echo "5. If using SSO: Token may not be authorized for the organization"
            echo ""
            echo "ACTION REQUIRED:"
            echo "1. Go to GitHub → Settings → Developer settings → Personal access tokens"
            echo "2. Find the token used in DOCS_DEPLOY"
            echo "3. Verify it has access to: ${{ inputs.pages_repository }}"
            echo "4. Verify permissions: repo (classic) or Contents: Read/Write (fine-grained)"
            exit 1
          fi

      - name: Checkout Pages repo (production)
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.pages_repository }}
          ref: ${{ inputs.pages_ref }}
          token: ${{ secrets.pages_deploy_token }}
          path: pages

      - name: Sync built site into /${{ inputs.publish_path }}
        run: |
          set -euo pipefail
          mkdir -p "pages/${{ inputs.publish_path }}"
          rsync -a --delete ${{ inputs.mkdocs_site_dir }}/ "pages/${{ inputs.publish_path }}/"

      - name: Commit & push to ${{ inputs.pages_ref }} (Pages repo)
        run: |
          set -euo pipefail
          cd pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "Publish docs from ${{ inputs.source_repository }}@${GITHUB_SHA}"
            git push origin ${{ inputs.pages_ref }}
          else
            echo "No changes to publish."
          fi
